<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊòüÁ©∫‰∏ªÈ¢òÁÇπÂêçÁ≥ªÁªü - ÊâãÂäøÂ¢ûÂº∫Áâà</title>
    
    <!-- ÂºïÂÖ•Á¨¨‰∏âÊñπÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- ÊâãÂäøËØÜÂà´Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <style>
        :root {
            --primary-color: #6a8cff;
            --secondary-color: #ff7eb9;
            --accent-color: #7fffcb;
            --light-color: #f8f9ff;
            --dark-color: #0f1123;
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --danger-color: #ff6b6b;
            --card-color: rgba(106, 140, 255, 0.2);
            --edit-color: #6a8cff;
            --sphere-color: #87CEEB;
            --name-card-bg: rgba(10, 25, 47, 0.7);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #000000;
            color: var(--light-color);
            min-height: 100vh;
            overflow: hidden;
        }
        
        #app {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
        }
        
        .sidebar {
            background: rgba(15, 17, 35, 0.85);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(106, 140, 255, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(106, 140, 255, 0.15);
            transition: transform 0.3s ease;
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .main-content {
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100vh;
        }
        
        .header {
            padding: 15px 20px;
            background: rgba(15, 17, 35, 0.6);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(106, 140, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100vh - 60px);
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: rgba(15, 17, 35, 0.9);
            padding: 30px 40px;
            border-radius: 15px;
            border: 1px solid var(--primary-color);
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 40px rgba(106, 140, 255, 0.3);
            transition: opacity 0.5s ease;
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 4px solid rgba(106, 140, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1.2s ease-in-out infinite;
        }
        
        .loading-progress {
            height: 8px;
            background: rgba(106, 140, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 4px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 0 10px rgba(106, 140, 255, 0.6);
        }
        
        h2 {
            font-size: 1.1rem;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 15px 0 10px 0;
            font-weight: 500;
            border-bottom: 1px solid rgba(106, 140, 255, 0.2);
            padding-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        select, button, input {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(106, 140, 255, 0.4);
            border-radius: 6px;
            background: rgba(15, 17, 35, 0.6);
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        select:focus, button:focus, input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(106, 140, 255, 0.3);
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236a8cff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
        }
        
        button {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.6), rgba(255, 126, 185, 0.6));
            color: white;
            border: 1px solid rgba(106, 140, 255, 0.4);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 0 15px rgba(106, 140, 255, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.7), rgba(255, 126, 185, 0.7));
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 0 15px rgba(106, 140, 255, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, rgba(255, 212, 59, 0.6), rgba(127, 255, 203, 0.6));
            color: #000;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--warning-color), var(--accent-color));
            box-shadow: 0 0 15px rgba(255, 212, 59, 0.4);
        }
        
        .student-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid rgba(106, 140, 255, 0.3);
            border-radius: 6px;
            background: rgba(15, 17, 35, 0.4);
        }
        
        .student-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(106, 140, 255, 0.1);
            transition: all 0.2s ease;
        }
        
        .student-item:last-child {
            border-bottom: none;
        }
        
        .student-item:hover {
            background: rgba(106, 140, 255, 0.1);
        }
        
        .student-item.selected {
            background: rgba(106, 140, 255, 0.2);
        }
        
        .student-item.called {
            opacity: 0.7;
        }
        
        .student-item.called::after {
            content: "‚úì";
            color: var(--success-color);
            margin-left: 10px;
        }
        
        .student-name {
            flex: 1;
            font-weight: 500;
        }
        
        .student-score {
            width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--success-color);
        }
        
        .student-score.negative {
            color: var(--danger-color);
        }
        
        .checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }
        
        .status-bar {
            text-align: center;
            font-weight: 600;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 10px 0;
            height: 24px;
            text-shadow: 0 0 5px rgba(106, 140, 255, 0.4);
        }
        
        .result-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            width: 90%;
            max-width: 600px;
            background: rgba(15, 17, 35, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(106, 140, 255, 0.3);
            border: 1px solid rgba(106, 140, 255, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            padding: 20px;
            text-align: center;
        }
        
        .result-card.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
            box-shadow: 0 0 50px rgba(106, 140, 255, 0.4);
        }
        
        .result-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(106, 140, 255, 0.6);
        }
        
        .result-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .result-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid rgba(106, 140, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(106, 140, 255, 0.3);
        }
        
        .result-add-point {
            background: linear-gradient(90deg, rgba(81, 207, 102, 0.7), rgba(127, 255, 203, 0.7));
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
        }
        
        .result-add-point:hover {
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.5);
        }
        
        .result-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .result-info {
            font-size: 1rem;
            color: var(--light-color);
            margin-bottom: 3px;
        }
        
        .result-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--success-color);
            margin-bottom: 8px;
        }
        
        .result-score.negative {
            color: var(--danger-color);
        }
        
        .result-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .group-add-point-btn {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.7), rgba(127, 255, 203, 0.7));
            margin-top: 15px;
            padding: 10px;
            width: 80%;
            font-weight: bold;
        }
        
        .group-add-point-btn:hover {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            box-shadow: 0 0 10px rgba(106, 140, 255, 0.5);
        }
        
        .add-point-btn, .remove-point-btn, .remove-btn {
            padding: 3px 8px;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
            flex: 1;
        }
        
        .add-point-btn {
            background: linear-gradient(90deg, rgba(81, 207, 102, 0.7), rgba(127, 255, 203, 0.7));
        }
        
        .add-point-btn:hover {
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.5);
        }
        
        .remove-point-btn {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.7), rgba(255, 212, 59, 0.7));
        }
        
        .remove-point-btn:hover {
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .remove-btn {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.7), rgba(255, 126, 185, 0.7));
        }
        
        .remove-btn:hover {
            background: linear-gradient(90deg, var(--danger-color), var(--secondary-color));
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .close-result {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(106, 140, 255, 0.3);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-result:hover {
            background: rgba(106, 140, 255, 0.1);
            transform: rotate(90deg);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .score-control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: #000;
            margin-left: 6px;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(15, 17, 35, 0.95);
            min-width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(106, 140, 255, 0.2);
            z-index: 100;
            border-radius: 6px;
            border: 1px solid rgba(106, 140, 255, 0.4);
            margin-top: 5px;
        }
        
        .dropdown-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dropdown-content a {
            color: white;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            transition: all 0.2s ease;
        }
        
        .dropdown-content a:hover {
            background-color: rgba(106, 140, 255, 0.1);
        }
        
        .dropdown-content a.selected {
            background-color: rgba(106, 140, 255, 0.2);
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.2), rgba(255, 126, 185, 0.2));
            color: var(--primary-color);
        }
        
        .dropdown-btn {
            width: 100%;
            text-align: center;
        }
        
        .voice-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .voice-toggle {
            width: 40px;
            height: 24px;
            background: rgba(106, 140, 255, 0.1);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            margin-right: 8px;
            border: 1px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .voice-toggle.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .voice-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .voice-toggle.active::after {
            left: calc(100% - 21px);
            background: #000;
        }
        
        .voice-label {
            font-size: 0.85rem;
            color: var(--light-color);
        }
        
        .file-input-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .file-input-label {
            display: block;
            padding: 10px 12px;
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.6), rgba(255, 126, 185, 0.6));
            color: white;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            border: 1px solid rgba(106, 140, 255, 0.4);
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 0 15px rgba(106, 140, 255, 0.4);
        }
        
        .file-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }
        
        .file-name {
            font-size: 0.85rem;
            margin-top: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
        }
        
        .music-control {
            display: flex;
            align-items: center;
            margin-top: 8px;
            gap: 8px;
        }
        
        .music-btn {
            flex: 1;
            padding: 6px;
            margin: 0;
        }
        
        .music-info {
            font-size: 0.8rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-top: 3px;
        }
        
        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.3), rgba(255, 126, 185, 0.3));
            color: white;
            border: 1px solid rgba(106, 140, 255, 0.6);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.5), rgba(255, 126, 185, 0.5));
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(106, 140, 255, 0.6);
        }

        .toggle-sidebar-btn {
            position: absolute;
            bottom: 75px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.3), rgba(255, 126, 185, 0.3));
            color: white;
            border: 1px solid rgba(106, 140, 255, 0.6);
            font-size: 1.1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .fullscreen-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            z-index: 10;
            display: none;
            border: 1px solid rgba(106, 140, 255, 0.3);
        }

        .toggle-sidebar-btn:hover {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.5), rgba(255, 126, 185, 0.5));
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(106, 140, 255, 0.6);
        }
        
        .toggle-sidebar-btn.visible {
            display: flex;
        }
      
        .fullscreen-indicator.show {
            display: block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 140, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(106, 140, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 140, 255, 0); }
        }
        
        .tech-glow {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(106, 140, 255, 0.2) 0%, rgba(106, 140, 255, 0) 70%);
            z-index: 0;
        }
        
        .file-help {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            text-align: center;
            line-height: 1.4;
        }
        
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 17, 35, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .edit-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .edit-content {
            background: rgba(15, 17, 35, 0.95);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 0 30px rgba(106, 140, 255, 0.3);
        }
        
        .edit-modal.show .edit-content {
            transform: translateY(0);
        }
        
        .edit-title {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .edit-form-group {
            margin-bottom: 15px;
        }
        
        .edit-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--light-color);
        }
        
        .edit-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(106, 140, 255, 0.5);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }
        
        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .edit-save, .edit-cancel {
            flex: 1;
            padding: 10px;
            font-size: 1rem;
            max-width: 120px;
        }
        
        .edit-save {
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
        }
        
        .edit-save:hover {
            background: linear-gradient(90deg, #41b755, #68e6b3);
            box-shadow: 0 0 15px rgba(81, 207, 102, 0.4);
        }
        
        .edit-cancel {
            background: linear-gradient(90deg, var(--danger-color), var(--secondary-color));
        }
        
        .edit-cancel:hover {
            background: linear-gradient(90deg, #ff5252, #ff6db2);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }
        
        .call-status {
            font-size: 0.85rem;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .three-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .performance-mode {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(15, 17, 35, 0.7);
            border: 1px solid rgba(106, 140, 255, 0.3);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 0.8rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .performance-mode:hover {
            background: rgba(106, 140, 255, 0.2);
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* ÊâãÂäøÊéßÂà∂Ê†∑Âºè */
        .gesture-control {
            margin-top: 10px;
            padding: 10px;
            background: rgba(15, 17, 35, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(106, 140, 255, 0.3);
        }
        
        .gesture-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .toggle-box {
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            position: relative;
            transition: 0.3s;
            margin-right: 10px;
        }
        
        .toggle-box::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        
        .toggle-box.active {
            background: var(--success-color);
        }
        
        .toggle-box.active::after {
            left: 22px;
        }
        
        #gesture-canvas {
            width: 100%;
            border-radius: 8px;
            background: #000;
            margin-top: 10px;
            border: 1px solid var(--accent-color);
            display: none;
        }
        
        .gesture-help {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        /* ÊâãÂäøÂèçÈ¶àÊ†∑Âºè */
        .gesture-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: white;
            z-index: 2000;
            pointer-events: none;
            text-shadow: 0 0 20px var(--primary-color);
            opacity: 0;
            animation: gestureFeedback 1s ease-out forwards;
        }
        
        @keyframes gestureFeedback {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
        }
        
        .score-records {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .score-record-header {
            display: grid;
            grid-template-columns: 1fr 80px 100px;
            padding: 10px;
            background: rgba(106, 140, 255, 0.1);
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .score-record-item {
            display: grid;
            grid-template-columns: 1fr 80px 100px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(106, 140, 255, 0.1);
        }

        .score-record-item:last-child {
            border-bottom: none;
        }

        .score-points {
            color: var(--success-color);
            font-weight: bold;
            text-align: center;
        }

        .score-points.negative {
            color: var(--danger-color);
        }

        .score-time {
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            font-size: 0.9em;
        }

        .score-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .score-summary-table th,
        .score-summary-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(106, 140, 255, 0.2);
        }

        .score-summary-table th {
            background: rgba(106, 140, 255, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .score-summary-table tr:hover {
            background: rgba(106, 140, 255, 0.05);
        }

        .total-points {
            color: var(--success-color);
            font-weight: bold;
        }

        .total-points.negative {
            color: var(--danger-color);
        }

        .no-records {
            text-align: center;
            padding: 20px;
            color: #ccc;
            font-style: italic;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 17, 35, 0.9);
            color: var(--danger-color);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--danger-color);
            z-index: 1000;
            max-width: 80%;
            text-align: center;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .error-retry {
            margin-top: 15px;
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Èü≥‰πêÊéßÂà∂ÊåâÈíÆÊ†∑Âºè - ‰øÆÂ§çÈÉ®ÂàÜ */
        .music-control-btn {
            position: absolute;
            bottom: 130px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(106, 140, 255, 0.5);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .music-control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(106, 140, 255, 0.7);
        }

        /* Èü≥‰πêÊéßÂà∂Èù¢ÊùøÊ†∑Âºè */
        .music-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .music-panel.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .music-panel-content {
            background: rgba(15, 17, 35, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(106, 140, 255, 0.4);
            border-radius: 10px;
            padding: 15px;
            width: 280px;
            box-shadow: 0 0 30px rgba(106, 140, 255, 0.3);
            margin-bottom: 10px;
        }

        .music-panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
        }

        .music-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .music-close-btn:hover {
            background: rgba(106, 140, 255, 0.1);
        }

        .music-upload-section {
            margin-bottom: 15px;
        }

        .music-upload-btn {
            background: linear-gradient(90deg, rgba(106, 140, 255, 0.6), rgba(255, 126, 185, 0.6));
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            border: 1px solid rgba(106, 140, 255, 0.4);
            transition: all 0.3s ease;
        }

        .music-upload-btn:hover {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .music-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .music-action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(106, 140, 255, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .music-play-btn {
            background: linear-gradient(90deg, rgba(81, 207, 102, 0.7), rgba(127, 255, 203, 0.7));
        }

        .music-play-btn:hover {
            background: linear-gradient(90deg, var(--success-color), var(--accent-color));
        }

        .music-pause-btn {
            background: linear-gradient(90deg, rgba(255, 212, 59, 0.7), rgba(255, 126, 185, 0.7));
        }

        .music-pause-btn:hover {
            background: linear-gradient(90deg, var(--warning-color), var(--secondary-color));
        }

        .music-file-info {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #ccc;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            background: rgba(106, 140, 255, 0.1);
        }

        @media (max-width: 768px) {
            #app {
                grid-template-columns: 20% 80%;
                grid-template-rows: 1fr;
            }
            
            .sidebar {
                height: 100vh;
                max-height: 100vh;
                width: 100%;
            }
            
            .canvas-container {
                height: 100vh;
            }

            .sidebar.hidden + .main-content {
                width: 100%;
                margin-left: 0;
            }
            
            .main-content.expanded {
                grid-column: 1 / -1;
            }

            .result-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .music-panel {
                left: 10px;
                right: 10px;
                bottom: 80px;
            }

            .music-panel-content {
                width: auto;
                max-width: 300px;
                margin-left: auto;
                margin-right: auto;
            }

            .music-control-btn {
                bottom: 150px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .fullscreen-btn {
                bottom: 15px;
                right: 15px;
            }

            .toggle-sidebar-btn {
                bottom: 70px;
                right: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            h2 {
                font-size: 1rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .score-control-buttons {
                grid-template-columns: 1fr;
            }
            
            .result-title {
                font-size: 1.5rem;
            }
            
            .result-name {
                font-size: 1.2rem;
            }
            
            .gesture-help {
                font-size: 0.6rem;
            }

            .music-panel-content {
                width: 100%;
                max-width: 280px;
            }

            .music-control-btn {
                bottom: 140px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }

        .group-score-panel {
            background: rgba(15, 17, 35, 0.8);
            border: 1px solid rgba(106, 140, 255, 0.4);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .group-score-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .group-score-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .group-score-btn {
            padding: 8px;
            font-size: 0.9rem;
        }
        
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .name-tag {
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* ÂáèÂàÜÊåâÈíÆÊ†∑Âºè */
        .btn-danger {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.6), rgba(255, 212, 59, 0.6));
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }
        
        .group-remove-point-btn {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.7), rgba(255, 212, 59, 0.7));
            margin-top: 10px;
            padding: 10px;
            width: 80%;
            font-weight: bold;
        }
        
        .group-remove-point-btn:hover {
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
    </style>
</head>
<body>
    <!-- ÈîôËØØÊèêÁ§∫ÂÖÉÁ¥† -->
    <div class="error-message" id="error-message">
        <h3>Âú∫ÊôØÂä†ËΩΩÂ§±Ë¥•</h3>
        <p id="error-details">ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•ÊàñÂ∞ùËØïÂà∑Êñ∞È°µÈù¢</p>
        <button class="error-retry" id="error-retry">ÈáçËØïÂä†ËΩΩ</button>
    </div>
    
    <div class="tech-glow" style="width: 800px; height: 800px; top: -400px; left: -400px;"></div>
    <div class="tech-glow" style="width: 600px; height: 600px; bottom: -300px; right: -300px;"></div>
    
    <div id="app">
        <div class="sidebar">
            <h1>ÊòüÁ©∫‰∏ªÈ¢òÁÇπÂêçÁ≥ªÁªü</h1>
            
            <div class="control-group">
                <h2>Áè≠Á∫ßÈÄâÊã©</h2>
                <select id="class-select">
                    <option value="class1">ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ1Áè≠</option>
                    <option value="class2">ËΩØ‰ª∂Â∑•Á®ã2Áè≠</option>
                    <option value="class3">‰∫∫Â∑•Êô∫ËÉΩ3Áè≠</option>
                </select>
                
                <div class="call-status" id="call-status">
                    ÁÇπÂêçËøõÂ∫¶: 0/0 Â≠¶Áîü
                </div>
                
                <div class="file-input-container">
                    <label for="upload-file" class="file-input-label">
                        <i>üìÅ</i>‰∏ä‰º†Â≠¶ÁîüÂêçÂçï
                    </label>
                    <input type="file" id="upload-file" class="file-input" accept=".xlsx,.xls,.csv,.doc,.docx,.txt">
                    <div id="file-name" class="file-name"></div>
                    <div class="file-help">
                        ÊîØÊåÅExcel„ÄÅWord„ÄÅCSV„ÄÅTXT<br>
                        ËØ∑Á°Æ‰øùÂåÖÂê´ÂßìÂêçÂíåÂ≠¶ÂàÜÂàó
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h2>ÁÇπÂêçÊéßÂà∂</h2>
                <button id="start-roll-btn" class="btn-primary">
                    <i>üé≤</i>ÂºÄÂßãÁÇπÂêç (Á©∫Ê†ºÈîÆ)
                </button>
                <button id="stop-roll-btn" class="btn-secondary" disabled>
                    <i>‚èπÔ∏è</i>ÂÅúÊ≠¢ÁÇπÂêç
                </button>
                
                <div class="dropdown">
                    <button class="dropdown-btn btn-secondary" id="dropdown-toggle">
                        <i>üë•</i>ÈÄâÊã©‰∫∫Êï∞: <span id="selected-number-display">1‰∫∫</span>
                    </button>
                    <div class="dropdown-content" id="multi-select-dropdown">
                        <a href="#" data-number="1">1‰∫∫</a>
                        <a href="#" data-number="2">2‰∫∫</a>
                        <a href="#" data-number="3">3‰∫∫</a>
                        <a href="#" data-number="4">4‰∫∫</a>
                        <a href="#" data-number="5">5‰∫∫</a>
                    </div>
                </div>
                
                <div class="voice-control">
                    <div class="voice-toggle" id="voice-toggle"></div>
                    <span class="voice-label">ËØ≠Èü≥Êí≠Êä•</span>
                </div>
                
                <div class="status-bar" id="status">ÂáÜÂ§áÂ∞±Áª™</div>
            </div>
            
            <!-- Êñ∞Â¢ûÊâãÂäøÊéßÂà∂Âå∫Âüü -->
            <div class="control-group">
                <h2>ÊâãÂäø AI ÊéßÂà∂</h2>
                <div class="gesture-control">
                    <div class="gesture-toggle" id="gesture-toggle">
                        <div class="toggle-box"></div>
                        <span class="voice-label">ÂºÄÂêØÊâãÂäøÊÑüÂ∫î</span>
                    </div>
                    <video id="input-video" style="display:none;"></video>
                    <canvas id="gesture-canvas"></canvas>
                    <div class="gesture-help">
                        ‚úä Êè°Êã≥:ÂºÄÂßãÁÇπÂêç | üñêÔ∏è Âº†ÂºÄ:ÂÅúÊ≠¢ÁÇπÂêç | ‚úåÔ∏è ÊØîËÄ∂:ÂàáÊç¢‰∫∫Êï∞ | üëå OK:Âä†ÂàÜ | üëé ÊãáÊåáÂêë‰∏ã:ÂáèÂàÜ
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h2>Â≠¶ÁîüÁÆ°ÁêÜ</h2>
                <div class="score-control-buttons">
                    <button id="add-score-btn" class="btn-primary">
                        <i>‚ûï</i>Âä†ÂàÜ
                    </button>
                    <button id="remove-score-btn" class="btn-danger">
                        <i>‚ûñ</i>ÂáèÂàÜ
                    </button>
                </div>
                <div class="action-buttons">
                    <button id="reset-score-btn" class="btn-secondary">
                        <i>üîÑ</i>ÁßØÂàÜÈáçÁΩÆ
                    </button>
                    <button id="reset-call-btn" class="btn-secondary">
                        <i>üîÑ</i>ÈáçÁΩÆÁÇπÂêçËÆ∞ÂΩï
                    </button>
                </div>

                <button id="view-score-summary-btn" class="btn-primary" style="margin-top: 8px;">
                    <i>üìä</i>Êü•ÁúãÂä†ÂáèÂàÜÊÉÖÂÜµ
                </button>
            </div>
            
            <button id="export-btn" class="btn-primary">
                <i>üì§</i>ÂØºÂá∫ÁÇπÂêçÊï∞ÊçÆ
            </button>
            
            <div class="control-group">
                <h2>Â≠¶ÁîüÂàóË°® <span class="badge" id="selected-count">0</span></h2>
                <div class="student-list" id="student-list">
                    <!-- Â≠¶ÁîüÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h2>ÂΩìÂâçÁè≠Á∫ß: <span id="current-class">ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ1Áè≠</span></h2>
                <div>
                </div>
            </div>
            
            <div class="canvas-container">
                <div class="loading-indicator" id="loading-indicator">
                    <div class="loading-spinner"></div>
                    <div id="loading-text">Ê≠£Âú®Âä†ËΩΩÊòüÁ©∫Âú∫ÊôØ...</div>
                    <div class="loading-progress">
                        <div class="loading-bar" id="loading-bar"></div>
                    </div>
                    <div class="loading-detail" id="loading-detail">ÂàùÂßãÂåñÁéØÂ¢É...</div>
                </div>
                
                <div class="performance-mode" id="performance-mode">
                    ÊÄßËÉΩÊ®°Âºè: È´òÂìÅË¥®
                </div>
                
                <div class="three-container" id="three-container"></div>
                <canvas id="canvas"></canvas>
                
                <div class="particles-container" id="particles-container"></div>
                
                <button id="fullscreen-btn" class="fullscreen-btn">‚õ∂</button>
                <div id="fullscreen-indicator" class="fullscreen-indicator">ÂÖ®Â±èÊ®°Âºè: ÁÇπÂáªÁêÉ‰ΩìÂàáÊç¢ÁÇπÂêç</div>

                <button id="toggle-sidebar-btn" class="toggle-sidebar-btn">üìã</button>
                
                <!-- Èü≥‰πêÊéßÂà∂ÊåâÈíÆ - Áé∞Âú®‰ºöÊòæÁ§∫Âú®Âè≥‰∏ãËßí -->
                <button id="music-control-btn" class="music-control-btn">üéµ</button>
                
                <!-- Èü≥‰πêÊéßÂà∂Èù¢Êùø -->
                <div class="music-panel" id="music-panel">
                    <div class="music-panel-content">
                        <button class="music-close-btn" id="music-close-btn">√ó</button>
                        <h3 class="music-panel-title">ËÉåÊôØÈü≥‰πêÊéßÂà∂</h3>
                        
                        <div class="music-upload-section">
                            <label for="upload-music" class="music-upload-btn">
                                <i>üìÅ</i> ‰∏ä‰º†ËÉåÊôØÈü≥‰πê
                            </label>
                            <input type="file" id="upload-music" class="file-input" accept=".mp3,.wav,.ogg">
                            <div id="music-file-name" class="music-file-info">ÂÜÖÁΩÆ: ÊòüÈôÖÊº´Ê∏∏</div>
                        </div>
                        
                        <div class="music-actions">
                            <button id="play-music" class="music-action-btn music-play-btn" disabled>
                                <i>‚ñ∂Ô∏è</i>Êí≠Êîæ
                            </button>
                            <button id="pause-music" class="music-action-btn music-pause-btn" disabled>
                                <i>‚è∏Ô∏è</i>ÊöÇÂÅú
                            </button>
                        </div>
                        
                        <div id="music-status" class="music-file-info">ËØ∑‰∏ä‰º†Êàñ‰ΩøÁî®ÂÜÖÁΩÆÈü≥‰πê</div>
                    </div>
                </div>
                
                <div class="result-card" id="result-card">
                    <button class="close-result" id="close-result">‚úï</button>
                    <h2 class="result-title">ÈÄâ‰∏≠ÁöÑÂ≠¶Áîü</h2>
                    <div class="result-list" id="result-list"></div>
                    <button class="group-add-point-btn" id="group-add-point-btn">
                        <i>üèÜ</i>‰∏∫ÊâÄÊúâÈÄâ‰∏≠Â≠¶ÁîüÂä†1ÂàÜ
                    </button>
                    <button class="group-remove-point-btn" id="group-remove-point-btn">
                        <i>‚ö†Ô∏è</i>‰∏∫ÊâÄÊúâÈÄâ‰∏≠Â≠¶ÁîüÂáè1ÂàÜ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="edit-modal" id="edit-modal">
        <div class="edit-content">
            <h3 class="edit-title">ÁºñËæëÂ≠¶Áîü‰ø°ÊÅØ</h3>
            <input type="hidden" id="edit-student-id">
            <div class="edit-form-group">
                <label class="edit-label" for="edit-student-name">ÂßìÂêç</label>
                <input type="text" id="edit-student-name" class="edit-input">
            </div>
            <div class="edit-form-group">
                <label class="edit-label" for="edit-student-score">Â≠¶ÂàÜ</label>
                <input type="number" id="edit-student-score" class="edit-input" min="0" step="0.5">
            </div>
            <div class="edit-actions">
                <button class="edit-save">‰øùÂ≠ò</button>
                <button class="edit-cancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- Âä†ÂáèÂàÜÊÉÖÂÜµÂºπÁ™ó -->
    <div class="edit-modal" id="score-summary-modal">
        <div class="edit-content" style="max-width: 500px;">
            <h3 class="edit-title">Êú¨ËäÇËØæÂä†ÂáèÂàÜÊÉÖÂÜµ</h3>
            <div class="score-summary-content" id="score-summary-content">
                <!-- Âä†ÂáèÂàÜÊÉÖÂÜµÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="edit-actions">
                <button class="edit-cancel" id="close-score-summary">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script>
        const performanceConfig = {
            isLowEndDevice: false,
            starCount: 2000,
            cardTrailCount: 20,
            enableShadows: true,
            animationQuality: 'high'
        };
        
        const state = {
            students: [],
            selectedNumber: 1,
            isRolling: false,
            rollingInterval: null,
            selectedStudents: [],
            calledStudents: [],
            voiceEnabled: false,
            gestureEnabled: false,
            performanceMode: 'high',
            music: null,
            currentClass: 'ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ1Áè≠',
            scoreRecords: [],
            gestureTimeout: 0,
            hands: null,
            cameraAI: null,
            
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            sphere: null,
            stars: [],
            nameTags: [],
            sphereRotationSpeed: 0.005,
            isSphereRotating: false,
            animationId: null,
            sceneLoaded: false,
            loadAttempts: 0,
            maxLoadAttempts: 3,
            musicError: null,
            musicLoading: false,
            cards: [],
            cardGroup: null,
            currentRotationSpeed: { y: 0.005, x: 0.002 },
            isAnimatingCards: false,
            cardAnimationProgress: 0,
            isAnimatingSphere: false,
            sphereAnimationProgress: 0,
            selectedCard: null,
            classData: {
                class1: [
                    { id: 1, name: "Âº†‰∏â", score: 0, attendance: 0, called: false },
                    { id: 2, name: "ÊùéÂõõ", score: 0, attendance: 0, called: false },
                    { id: 3, name: "Áéã‰∫î", score: 0, attendance: 0, called: false },
                    { id: 4, name: "ËµµÂÖ≠", score: 0, attendance: 0, called: false },
                    { id: 5, name: "Èí±‰∏É", score: 0, attendance: 0, called: false },
                    { id: 6, name: "Â≠ôÂÖ´", score: 0, attendance: 0, called: false },
                    { id: 7, name: "Âë®‰πù", score: 0, attendance: 0, called: false },
                    { id: 8, name: "Âê¥ÂçÅ", score: 0, attendance: 0, called: false }
                ],
                class2: [
                    { id: 1, name: "Tom", score: 0, attendance: 0, called: false },
                    { id: 2, name: "Jerry", score: 0, attendance: 0, called: false },
                    { id: 3, name: "Alice", score: 0, attendance: 0, called: false },
                    { id: 4, name: "Bob", score: 0, attendance: 0, called: false }
                ],
                class3: [
                    { id: 1, name: "Â∞èÊòé", score: 0, attendance: 0, called: false },
                    { id: 2, name: "Â∞èÁ∫¢", score: 0, attendance: 0, called: false },
                    { id: 3, name: "Â∞èÂàö", score: 0, attendance: 0, called: false },
                    { id: 4, name: "Â∞è‰∏Ω", score: 0, attendance: 0, called: false },
                    { id: 5, name: "Â∞èÂº∫", score: 0, attendance: 0, called: false }
                ]
            },
            currentClassKey: "class1",
            musicPanelVisible: false
        };
        
        const rotationSpeeds = {
            normal: { y: 0.005, x: 0.002 },
            fast: { y: 0.05, x: 0.01 },
            fastest: { y: 0.15, x: 0.03 }
        };

        const elements = {
            startRollBtn: document.getElementById('start-roll-btn'),
            stopRollBtn: document.getElementById('stop-roll-btn'),
            studentList: document.getElementById('student-list'),
            resultCard: document.getElementById('result-card'),
            resultList: document.getElementById('result-list'),
            closeResult: document.getElementById('close-result'),
            statusBar: document.getElementById('status'),
            voiceToggle: document.getElementById('voice-toggle'),
            callStatus: document.getElementById('call-status'),
            selectedCount: document.getElementById('selected-count'),
            dropdownToggle: document.getElementById('dropdown-toggle'),
            multiSelectDropdown: document.getElementById('multi-select-dropdown'),
            selectedNumberDisplay: document.getElementById('selected-number-display'),
            uploadFile: document.getElementById('upload-file'),
            fileName: document.getElementById('file-name'),
            classSelect: document.getElementById('class-select'),
            currentClass: document.getElementById('current-class'),
            addScoreBtn: document.getElementById('add-score-btn'),
            removeScoreBtn: document.getElementById('remove-score-btn'),
            resetScoreBtn: document.getElementById('reset-score-btn'),
            resetCallBtn: document.getElementById('reset-call-btn'),
            exportBtn: document.getElementById('export-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            fullscreenIndicator: document.getElementById('fullscreen-indicator'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
            sidebar: document.querySelector('.sidebar'),
            performanceMode: document.getElementById('performance-mode'),
            loadingIndicator: document.getElementById('loading-indicator'),
            loadingBar: document.getElementById('loading-bar'),
            loadingText: document.getElementById('loading-text'),
            loadingDetail: document.getElementById('loading-detail'),
            playMusic: document.getElementById('play-music'),
            pauseMusic: document.getElementById('pause-music'),
            uploadMusic: document.getElementById('upload-music'),
            musicFileName: document.getElementById('music-file-name'),
            editModal: document.getElementById('edit-modal'),
            editStudentId: document.getElementById('edit-student-id'),
            editStudentName: document.getElementById('edit-student-name'),
            editStudentScore: document.getElementById('edit-student-score'),
            editSave: document.querySelector('.edit-save'),
            editCancel: document.querySelector('.edit-cancel'),
            groupAddPointBtn: document.getElementById('group-add-point-btn'),
            groupRemovePointBtn: document.getElementById('group-remove-point-btn'),
            musicStatus: document.getElementById('music-status'),
            threeContainer: document.getElementById('three-container'),
            errorMessage: document.getElementById('error-message'),
            errorDetails: document.getElementById('error-details'),
            errorRetry: document.getElementById('error-retry'),
            gestureToggle: document.getElementById('gesture-toggle'),
            gestureCanvas: document.getElementById('gesture-canvas'),
            inputVideo: document.getElementById('input-video'),
            viewScoreSummaryBtn: document.getElementById('view-score-summary-btn'),
            scoreSummaryModal: document.getElementById('score-summary-modal'),
            closeScoreSummary: document.getElementById('close-score-summary'),
            scoreSummaryContent: document.getElementById('score-summary-content'),
            musicControlBtn: document.getElementById('music-control-btn'),
            musicPanel: document.getElementById('music-panel'),
            musicCloseBtn: document.getElementById('music-close-btn')
        };

        // ================ ÊâãÂäøËØÜÂà´ÂäüËÉΩ ================
        function initGestureRecognition() {
            const videoElement = elements.inputVideo;
            const canvasElement = elements.gestureCanvas;
            const canvasCtx = canvasElement.getContext('2d');
            
            canvasElement.width = 320;
            canvasElement.height = 240;
            
            state.hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            
            state.hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });
            
            state.hands.onResults((results) => {
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    analyzeGesture(results.multiHandLandmarks[0]);
                }
                
                canvasCtx.restore();
            });
            
            state.cameraAI = new Camera(videoElement, {
                onFrame: async () => {
                    if (state.gestureEnabled) {
                        try {
                            await state.hands.send({image: videoElement});
                        } catch (error) {
                            console.error('ÊâãÂäøËØÜÂà´ÈîôËØØ:', error);
                        }
                    }
                },
                width: 320,
                height: 240
            });
        }
        
        function toggleGesture() {
            state.gestureEnabled = !state.gestureEnabled;
            const toggleBox = elements.gestureToggle.querySelector('.toggle-box');
            toggleBox.classList.toggle('active');
            elements.gestureCanvas.style.display = state.gestureEnabled ? 'block' : 'none';
            
            if (state.gestureEnabled) {
                state.cameraAI.start();
                showStatus('ÊâãÂäøÊéßÂà∂Â∑≤ÂºÄÂêØ', 'success');
            } else {
                state.cameraAI.stop();
                showStatus('ÊâãÂäøÊéßÂà∂Â∑≤ÂÖ≥Èó≠', 'info');
            }
        }
        
        function analyzeGesture(landmarks) {
            const now = Date.now();
            if (now - state.gestureTimeout < 1500) return;
            
            // Âü∫Á°ÄÂà§ÂÆöÔºöÊåáÂ∞ñÊòØÂê¶È´ò‰∫éÊåáÊ†π
            const thumbExtended = landmarks[4].x < landmarks[3].x; 
            const indexExtended = landmarks[8].y < landmarks[6].y;
            const middleExtended = landmarks[12].y < landmarks[10].y;
            const ringExtended = landmarks[16].y < landmarks[14].y;
            const pinkyExtended = landmarks[20].y < landmarks[18].y;
            const extendedCount = [indexExtended, middleExtended, ringExtended, pinkyExtended].filter(Boolean).length;
            
            // 1. ‚úä Êè°Êã≥ -> ÂºÄÂßãÁÇπÂêç
            if (extendedCount === 0 && !thumbExtended && !state.isRolling) {
                startRollCall();
                triggerGestureEffect('ÂºÄÂßãÁÇπÂêç', '‚úä');
                state.gestureTimeout = now;
            } 
            // 2. üñêÔ∏è Âº†ÂºÄ -> ÂÅúÊ≠¢ÁÇπÂêç
            else if (extendedCount === 4 && thumbExtended && state.isRolling) {
                stopRollCall();
                triggerGestureEffect('ÂÅúÊ≠¢ÁÇπÂêç', 'üñêÔ∏è');
                state.gestureTimeout = now;
            }
            // 3. ‚úåÔ∏è ÊØîËÄ∂ -> ÂàáÊç¢‰∫∫Êï∞
            else if (indexExtended && middleExtended && !ringExtended && !pinkyExtended) {
                state.selectedNumber = (state.selectedNumber % 5) + 1;
                elements.selectedNumberDisplay.textContent = `${state.selectedNumber}‰∫∫`;
                elements.multiSelectDropdown.querySelectorAll('a').forEach(i => i.classList.remove('selected'));
                elements.multiSelectDropdown.querySelector(`a[data-number="${state.selectedNumber}"]`).classList.add('selected');
                triggerGestureEffect(`ÂàáÊç¢: ${state.selectedNumber}‰∫∫`, '‚úåÔ∏è');
                state.gestureTimeout = now;
            }
            // 4. üëå OKÊâãÂäø -> Âä†ÂàÜ
            else if (Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y) < 0.05 && middleExtended) {
                if (state.selectedStudents.length > 0) {
                    addScoreToAllSelectedInResult(1);
                    triggerGestureEffect('Âä†ÂàÜ +1', 'üëå');
                } else {
                    addScoreToSelected(1);
                    triggerGestureEffect('‰∏∫ÈÄâ‰∏≠Â≠¶ÁîüÂä†ÂàÜ +1', 'üëå');
                }
                state.gestureTimeout = now;
            }
            // 5. üëé ÊãáÊåáÂêë‰∏ã -> ÂáèÂàÜ (Êñ∞Â¢ûÊâãÂäø)
            else if (!thumbExtended && indexExtended && !middleExtended && !ringExtended && !pinkyExtended) {
                if (state.selectedStudents.length > 0) {
                    addScoreToAllSelectedInResult(-1);
                    triggerGestureEffect('ÂáèÂàÜ -1', 'üëé');
                } else {
                    addScoreToSelected(-1);
                    triggerGestureEffect('‰∏∫ÈÄâ‰∏≠Â≠¶ÁîüÂáèÂàÜ -1', 'üëé');
                }
                state.gestureTimeout = now;
            }
        }
        
        function triggerGestureEffect(text, emoji) {
            const div = document.createElement('div');
            div.className = 'gesture-feedback';
            div.innerHTML = `${emoji}<br><span style="font-size: 1.5rem;">${text}</span>`;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 1000);
        }

        // ================ Èü≥‰πêÊéßÂà∂ÂäüËÉΩ ================
        function toggleMusicPanel() {
            state.musicPanelVisible = !state.musicPanelVisible;
            if (state.musicPanelVisible) {
                elements.musicPanel.classList.add('show');
                elements.musicControlBtn.style.transform = 'scale(1.1)';
                elements.musicControlBtn.style.boxShadow = '0 0 30px rgba(106, 140, 255, 0.7)';
            } else {
                elements.musicPanel.classList.remove('show');
                elements.musicControlBtn.style.transform = 'scale(1)';
                elements.musicControlBtn.style.boxShadow = '0 0 20px rgba(106, 140, 255, 0.5)';
            }
        }

        function handleMusicUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('audio.*')) {
                showStatus('ËØ∑‰∏ä‰º†Èü≥È¢ëÊñá‰ª∂', 'error');
                return;
            }
            
            elements.musicFileName.textContent = file.name;
            
            if (state.music) {
                state.music.pause();
                state.music = null;
            }
            
            const objectURL = URL.createObjectURL(file);
            state.music = new Audio(objectURL);
            state.music.loop = true;
            state.music.volume = 0.5;
            
            state.music.addEventListener('canplaythrough', () => {
                elements.playMusic.disabled = false;
                elements.musicStatus.textContent = `Â∑≤Âä†ËΩΩ: ${file.name}`;
                showStatus(`Èü≥‰πêÊñá‰ª∂Â∑≤Âä†ËΩΩ: ${file.name}`, 'success');
            });
            
            state.music.addEventListener('error', (e) => {
                console.error('Èü≥‰πêÂä†ËΩΩÈîôËØØ:', e);
                elements.musicStatus.textContent = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÊñá‰ª∂';
                showStatus('Èü≥‰πêÊñá‰ª∂Âä†ËΩΩÂ§±Ë¥•', 'error');
                elements.playMusic.disabled = true;
                elements.pauseMusic.disabled = true;
            });
        }
        
        function playMusic() {
            if (state.music) {
                state.music.play().then(() => {
                    elements.playMusic.disabled = true;
                    elements.pauseMusic.disabled = false;
                    elements.musicStatus.textContent = 'Êí≠Êîæ‰∏≠...';
                    showStatus('ËÉåÊôØÈü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ', 'success');
                }).catch(error => {
                    console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                    showStatus('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Èü≥È¢ëÊñá‰ª∂', 'error');
                });
            } else {
                showStatus('ËØ∑ÂÖà‰∏ä‰º†Èü≥‰πêÊñá‰ª∂', 'warning');
            }
        }
        
        function pauseMusic() {
            if (state.music) {
                state.music.pause();
                elements.playMusic.disabled = false;
                elements.pauseMusic.disabled = true;
                elements.musicStatus.textContent = 'Â∑≤ÊöÇÂÅú';
                showStatus('ËÉåÊôØÈü≥‰πêÂ∑≤ÊöÇÂÅú', 'info');
            }
        }
        
        // ================ Êñ∞Â¢ûÔºöÂÅúÊ≠¢Èü≥‰πêÂäüËÉΩ ================
        function stopMusic() {
            if (state.music) {
                state.music.pause();
                elements.playMusic.disabled = false;
                elements.pauseMusic.disabled = true;
                elements.musicStatus.textContent = 'Â∑≤ÂÅúÊ≠¢';
                showStatus('ËÉåÊôØÈü≥‰πêÂ∑≤ÂÅúÊ≠¢', 'info');
            }
        }

        // ================ ÂéüÊúâÂäüËÉΩ ================
        function detectPerformance() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const hasLowMemory = navigator.deviceMemory && navigator.deviceMemory < 4;
            
            performanceConfig.isLowEndDevice = isMobile || hasLowMemory;
            
            if (performanceConfig.isLowEndDevice) {
                performanceConfig.starCount = 800;
                performanceConfig.cardTrailCount = 5;
                performanceConfig.enableShadows = false;
                performanceConfig.animationQuality = 'low';
                return 'low';
            } else {
                return 'high';
            }
        }
        
        function applyPerformanceSettings() {
            if (state.performanceMode === 'low') {
                performanceConfig.starCount = 800;
                performanceConfig.cardTrailCount = 5;
                performanceConfig.enableShadows = false;
                performanceConfig.animationQuality = 'low';
                
                state.currentRotationSpeed = {
                    normal: { y: 0.003, x: 0.001 },
                    fast: { y: 0.03, x: 0.008 },
                    fastest: { y: 0.08, x: 0.02 }
                };
            } else {
                performanceConfig.starCount = 2000;
                performanceConfig.cardTrailCount = 20;
                performanceConfig.enableShadows = true;
                performanceConfig.animationQuality = 'high';
                
                state.currentRotationSpeed = {
                    normal: { y: 0.005, x: 0.002 },
                    fast: { y: 0.05, x: 0.01 },
                    fastest: { y: 0.15, x: 0.03 }
                };
            }
            
            if (state.renderer) {
                state.renderer.shadowMap.enabled = performanceConfig.enableShadows;
            }
        }
        
        function updateLoadingStatus(percent, text, detail = '') {
            elements.loadingBar.style.width = `${percent}%`;
            elements.loadingText.textContent = text;
            if (detail) {
                elements.loadingDetail.textContent = detail;
            }
            
            if (percent === 100) {
                setTimeout(() => {
                    elements.loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        elements.loadingIndicator.style.display = 'none';
                    }, 500);
                }, 800);
            }
        }
        
        function initSampleStudents() {
            state.students = [...state.classData[state.currentClassKey]];
            state.students.sort((a, b) => b.score - a.score);
            renderStudentList();
            updateCallStatus();
            
            if (state.sceneLoaded) {
                createStudentCards();
            } else {
                const checkSceneLoaded = setInterval(() => {
                    if (state.sceneLoaded) {
                        createStudentCards();
                        clearInterval(checkSceneLoaded);
                    }
                }, 500);
            }
        }
        
        function renderStudentList() {
            elements.studentList.innerHTML = '';
            
            state.students.forEach(student => {
                const item = document.createElement('div');
                item.className = `student-item ${student.called ? 'called' : ''}`;
                item.innerHTML = `
                    <input type="checkbox" class="checkbox" data-id="${student.id}">
                    <div class="student-name">${student.name}</div>
                    <div class="student-score ${student.score < 0 ? 'negative' : ''}">${student.score}</div>
                `;
                
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('checkbox')) return;
                    const checkbox = item.querySelector('.checkbox');
                    checkbox.checked = !checkbox.checked;
                    updateSelectedCount();
                });
                
                const checkbox = item.querySelector('.checkbox');
                checkbox.addEventListener('change', updateSelectedCount);
                
                elements.studentList.appendChild(item);
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkedCount = document.querySelectorAll('.checkbox:checked').length;
            elements.selectedCount.textContent = checkedCount;
        }

        function updateCallStatus() {
            const calledCount = state.students.filter(s => s.called).length;
            elements.callStatus.textContent = `ÁÇπÂêçËøõÂ∫¶: ${calledCount}/${state.students.length} Â≠¶Áîü`;
        }

        function startRollCall() {
            if (state.students.length === 0) {
                showStatus('ËØ∑ÂÖà‰∏ä‰º†Â≠¶ÁîüÂêçÂçï', 'warning');
                return;
            }
            
            if (!state.sceneLoaded) {
                showStatus('ÊòüÁ©∫Âú∫ÊôØÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂÄô...', 'warning');
                return;
            }
            
            if (state.rollingInterval) {
                clearInterval(state.rollingInterval);
            }
            
            state.isRolling = true;
            elements.startRollBtn.disabled = true;
            elements.stopRollBtn.disabled = false;
            showStatus('Ê≠£Âú®ÈöèÊú∫ÁÇπÂêç...', 'info');
            elements.resultCard.classList.remove('show');
            state.isSphereRotating = true;
            state.currentRotationSpeed = rotationSpeeds.fastest;
            formSphereAndRotate();
            
            // ================ Êñ∞Â¢ûÔºöÂºÄÂßãÁÇπÂêçÊó∂Ëá™Âä®Êí≠ÊîæËÉåÊôØÈü≥‰πê ================
            if (state.music) {
                state.music.play().then(() => {
                    elements.playMusic.disabled = true;
                    elements.pauseMusic.disabled = false;
                    elements.musicStatus.textContent = 'Êí≠Êîæ‰∏≠...';
                    showStatus('ÁÇπÂêçÂºÄÂßãÔºåËÉåÊôØÈü≥‰πêÂ∑≤Ëá™Âä®Êí≠Êîæ', 'success');
                }).catch(error => {
                    console.error('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', error);
                    showStatus('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåÁªßÁª≠ÁÇπÂêçÊµÅÁ®ã', 'warning');
                });
            } else {
                showStatus('ÁÇπÂêçÂºÄÂßãÔºåÊú™Ê£ÄÊµãÂà∞ËÉåÊôØÈü≥‰πê', 'info');
            }
            
            state.rollingInterval = setInterval(() => {
                selectRandomStudents();
            }, 100);
        }

        function stopRollCall() {
            if (state.rollingInterval) {
                clearInterval(state.rollingInterval);
                state.rollingInterval = null;
            }
            
            state.isRolling = false;
            elements.startRollBtn.disabled = false;
            elements.stopRollBtn.disabled = true;
            state.currentRotationSpeed = rotationSpeeds.normal;
            selectRandomStudents(true);
            setTimeout(() => {
                elements.resultCard.classList.add('show');
            }, 50);
            
            state.selectedStudents.forEach(student => {
                const found = state.students.find(s => s.id === student.id);
                if (found && !found.called) {
                    found.called = true;
                }
            });
            
            renderStudentList();
            updateCallStatus();
            showStatus('ÁÇπÂêçÂ∑≤ÂÅúÊ≠¢', 'success');
            keepCardsOnSphere();
            
            // ================ Êñ∞Â¢ûÔºöÁªìÊùüÁÇπÂêçÊó∂Ëá™Âä®ÊöÇÂÅúËÉåÊôØÈü≥‰πê ================
            if (state.music && !state.music.paused) {
                state.music.pause();
                elements.playMusic.disabled = false;
                elements.pauseMusic.disabled = true;
                elements.musicStatus.textContent = 'Â∑≤ÊöÇÂÅú';
                showStatus('ÁÇπÂêçÁªìÊùüÔºåËÉåÊôØÈü≥‰πêÂ∑≤ÊöÇÂÅú', 'info');
            }
            
            if (state.voiceEnabled) {
                speakResults();
            }
        }
        
        function formSphereAndRotate() {
            state.isAnimatingSphere = true;
            state.sphereAnimationProgress = 0;
            state.cardGroup.rotation.set(0, 0, 0);
            
            state.cards.forEach((card, index) => {
                if (!card.userData.originalGridPosition) {
                    card.userData.originalGridPosition = card.position.clone();
                }
                const targetPos = card.userData.spherePosition;
                gsap.to(card.position, {
                    x: targetPos.x,
                    y: targetPos.y,
                    z: targetPos.z,
                    duration: 1.0,
                    ease: "power2.out",
                    onUpdate: () => {
                        card.lookAt(new THREE.Vector3(0, 0, 0));
                    }
                });
                
                gsap.to(card.scale, {
                    x: 0.6,
                    y: 0.6,
                    z: 0.6,
                    duration: 1.0,
                    ease: "power2.out"
                });
            });
            
            state.sphere.visible = true;
            gsap.to(state.sphere.material, {
                opacity: 0.3,
                duration: 1,
                ease: "power2.out"
            });
            
            gsap.to(state.sphere.scale, {
                x: 0.8, 
                y: 0.8,
                z: 0.8,
                duration: 1.0,
                ease: "power2.out"
            });
        }
        
        function keepCardsOnSphere() {
            state.cards.forEach((card, index) => {
                if (card.userData.spherePosition) {
                    gsap.to(card.position, {
                        x: card.userData.spherePosition.x * 0.8,
                        y: card.userData.spherePosition.y * 0.8,
                        z: card.userData.spherePosition.z * 0.8,
                        duration: 1.0,
                        ease: "power2.out",
                        onUpdate: () => {
                            card.lookAt(new THREE.Vector3(0, 0, 0));
                        }
                    });
                }
                
                gsap.to(card.scale, {
                    x: card.userData.baseScale * 0.33,
                    y: card.userData.baseScale * 0.33,
                    z: card.userData.baseScale * 0.33,
                    duration: 1.0,
                    ease: "power2.out"
                });
            });
            
            gsap.to(state.sphere.material, {
                opacity: 0.1,
                duration: 1,
                ease: "power2.out"
            });
        }
        
        function selectRandomStudents(finalSelection = false) {
            let availableStudents = [...state.students];
            if (finalSelection) {
                availableStudents = availableStudents.filter(s => !s.called);
            }
            
            if (availableStudents.length === 0) {
                availableStudents.push(...state.students);
            }
            
            const actualNumber = Math.min(state.selectedNumber, availableStudents.length);
            const selected = [];
            const tempStudents = [...availableStudents];
            
            for (let i = 0; i < actualNumber; i++) {
                const randomIndex = Math.floor(Math.random() * tempStudents.length);
                selected.push(tempStudents[randomIndex]);
                tempStudents.splice(randomIndex, 1);
            }
            
            state.selectedStudents = selected;
            renderResults();
            
            if (finalSelection) {
                state.cards.forEach(card => {
                    const isSelected = state.selectedStudents.some(s => s.id === card.userData.studentId);
                    if (card.material && card.material.uniforms) {
                        card.material.uniforms.selected.value = isSelected ? 1 : 0;
                    }
                    
                    if (isSelected && finalSelection) {
                        card.scale.set(
                            card.userData.baseScale * 1.2, 
                            card.userData.baseScale * 1.2, 
                            card.userData.baseScale * 1.2
                        );
                        
                        card.userData.originalPosition = card.position.clone();
                    } else {
                        card.scale.set(
                            card.userData.baseScale, 
                            card.userData.baseScale, 
                            card.userData.baseScale
                        );
                    }
                });
            }
        }
        
        function renderResults() {
            elements.resultList.innerHTML = '';
            if (state.selectedStudents.length === 0) {
                const emptyResult = document.createElement('div');
                emptyResult.className = 'result-empty';
                emptyResult.textContent = 'Ê≤°ÊúâÈÄâ‰∏≠ÁöÑÂ≠¶Áîü';
                elements.resultList.appendChild(emptyResult);
                return;
            }
            
            state.selectedStudents.forEach(student => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <div class="result-name">${student.name}</div>
                    <div class="result-score ${student.score < 0 ? 'negative' : ''}">Â≠¶ÂàÜ: ${student.score}</div>
                    <div class="result-actions">
                        <button class="add-point-btn" data-id="${student.id}">+1ÂàÜ</button>
                        <button class="remove-point-btn" data-id="${student.id}">-1ÂàÜ</button>
                        <button class="remove-btn" data-id="${student.id}">ÁßªÈô§</button>
                    </div>
                `;
                
                elements.resultList.appendChild(resultItem);
            });
        }
        
        function removeStudentFromResults(studentId) {
            state.selectedStudents = state.selectedStudents.filter(s => s.id !== studentId);
            renderResults();
            highlightSelectedStudents();
        }
        
        function addScore(studentId, points) {
            const student = state.students.find(s => s.id === studentId);
            if (student) {
                student.score += points;
                state.scoreRecords.push({
                    studentId: studentId,
                    studentName: student.name,
                    points: points,
                    timestamp: new Date()
                });
                
                if (state.selectedStudents.length === 0) {
                    elements.resultCard.classList.remove('show');
                }
                
                state.students.sort((a, b) => b.score - a.score);
                renderStudentList();
                renderResults();
                updateCardScore(studentId, student.score);
                
                if (state.voiceEnabled) {
                    if (points > 0) {
                        speakText(`${student.name}Âä†ÂàÜ${points}ÂàÜ`);
                    } else if (points < 0) {
                        speakText(`${student.name}ÂáèÂàÜ${Math.abs(points)}ÂàÜ`);
                    }
                }
            }
        }
        
        function addScoreToSelected(points) {
            const selectedIds = Array.from(document.querySelectorAll('.checkbox:checked'))
                .map(checkbox => parseInt(checkbox.dataset.id));
            
            if (selectedIds.length === 0) {
                showStatus('ËØ∑ÂÖàÈÄâÊã©Â≠¶Áîü', 'warning');
                return;
            }
            
            selectedIds.forEach(id => {
                addScore(id, points);
            });
            
            if (points > 0) {
                showStatus(`Â∑≤‰∏∫${selectedIds.length}ÂêçÂ≠¶ÁîüÂä†${points}ÂàÜ`, 'success');
            } else if (points < 0) {
                showStatus(`Â∑≤‰∏∫${selectedIds.length}ÂêçÂ≠¶ÁîüÂáè${Math.abs(points)}ÂàÜ`, points === -1 ? 'warning' : 'error');
            }
        }

        function addScoreToAllSelectedInResult(points) {
            if (state.selectedStudents.length === 0) {
                showStatus('Ê≤°ÊúâÈÄâ‰∏≠ÁöÑÂ≠¶Áîü', 'warning');
                return;
            }
            
            state.selectedStudents.forEach(student => {
                addScore(student.id, points);
            });
            
            if (points > 0) {
                showStatus(`Â∑≤‰∏∫ÊâÄÊúâ${state.selectedStudents.length}ÂêçÈÄâ‰∏≠Â≠¶ÁîüÂä†${points}ÂàÜ`, 'success');
            } else if (points < 0) {
                showStatus(`Â∑≤‰∏∫ÊâÄÊúâ${state.selectedStudents.length}ÂêçÈÄâ‰∏≠Â≠¶ÁîüÂáè${Math.abs(points)}ÂàÜ`, points === -1 ? 'warning' : 'error');
            }
        }
        
        // ================ Êñ∞Â¢ûÔºöÂáèÂàÜÂäüËÉΩ ================
        function removeScoreFromSelected(points = 1) {
            const selectedIds = Array.from(document.querySelectorAll('.checkbox:checked'))
                .map(checkbox => parseInt(checkbox.dataset.id));
            
            if (selectedIds.length === 0) {
                showStatus('ËØ∑ÂÖàÈÄâÊã©Â≠¶Áîü', 'warning');
                return;
            }
            
            selectedIds.forEach(id => {
                addScore(id, -points);
            });
            
            showStatus(`Â∑≤‰∏∫${selectedIds.length}ÂêçÂ≠¶ÁîüÂáè${points}ÂàÜ`, 'warning');
        }

        function removeScoreFromAllSelectedInResult(points = 1) {
            if (state.selectedStudents.length === 0) {
                showStatus('Ê≤°ÊúâÈÄâ‰∏≠ÁöÑÂ≠¶Áîü', 'warning');
                return;
            }
            
            state.selectedStudents.forEach(student => {
                addScore(student.id, -points);
            });
            
            showStatus(`Â∑≤‰∏∫ÊâÄÊúâ${state.selectedStudents.length}ÂêçÈÄâ‰∏≠Â≠¶ÁîüÂáè${points}ÂàÜ`, 'warning');
        }
        
        function resetScores() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÂ≠¶ÁîüÁöÑÂàÜÊï∞ÂêóÔºü')) {
                state.students.forEach(student => {
                    student.score = 0;
                    updateCardScore(student.id, 0);
                });
                
                state.scoreRecords = [];
                renderStudentList();
                renderResults();
                showStatus('ÊâÄÊúâÂ≠¶ÁîüÂàÜÊï∞Â∑≤ÈáçÁΩÆ', 'info');
            }
        }
        
        function resetCallRecords() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÁÇπÂêçËÆ∞ÂΩïÂêóÔºü')) {
                state.students.forEach(student => {
                    student.called = false;
                });
                
                renderStudentList();
                updateCallStatus();
                showStatus('ÁÇπÂêçËÆ∞ÂΩïÂ∑≤ÈáçÁΩÆ', 'info');
                
                state.cards.forEach(card => {
                    gsap.to(card.position, {
                        x: card.userData.targetPosition.x,
                        y: card.userData.targetPosition.y,
                        z: card.userData.targetPosition.z,
                        duration: 1,
                        ease: "power2.out"
                    });
                    
                    if (card.material && card.material.uniforms) {
                        card.material.uniforms.selected.value = 0;
                    }
                });
            }
        }
        
        function showStatus(message, type = 'info') {
            elements.statusBar.textContent = message;
            switch(type) {
                case 'success':
                    elements.statusBar.style.background = 'linear-gradient(90deg, var(--success-color), var(--accent-color))';
                    break;
                case 'warning':
                    elements.statusBar.style.background = 'linear-gradient(90deg, var(--warning-color), #ff922b)';
                    break;
                case 'error':
                    elements.statusBar.style.background = 'linear-gradient(90deg, var(--danger-color), var(--secondary-color))';
                    break;
                default:
                    elements.statusBar.style.background = 'linear-gradient(90deg, var(--primary-color), var(--secondary-color))';
            }
            
            elements.statusBar.style.webkitBackgroundClip = 'text';
            elements.statusBar.style.backgroundClip = 'text';
            elements.statusBar.style.color = 'transparent';
        }
        
        function speakResults() {
            if (state.selectedStudents.length === 0) return;
            let text = 'ÈÄâ‰∏≠ÁöÑÂ≠¶ÁîüÊòØÔºö';
            state.selectedStudents.forEach((student, index) => {
                text += student.name;
                if (index < state.selectedStudents.length - 1) {
                    text += 'Ôºå';
                }
            });
            speakText(text);
        }
        
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    const speakWithPermission = () => {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'zh-CN';
                        utterance.rate = 0.9;
                        
                        utterance.onstart = () => {
                            showStatus('ËØ≠Èü≥Êí≠Êä•‰∏≠...', 'info');
                        };
                        
                        utterance.onend = () => {
                            showStatus('ËØ≠Èü≥Êí≠Êä•ÂÆåÊàê', 'success');
                        };
                        
                        utterance.onerror = (event) => {
                            console.error('ËØ≠Èü≥Êí≠Êä•ÈîôËØØ:', event.error);
                            showStatus('ËØ≠Èü≥Êí≠Êä•Â§±Ë¥•', 'error');
                        };
                        
                        window.speechSynthesis.speak(utterance);
                        
                        document.removeEventListener('click', speakWithPermission);
                        document.removeEventListener('touchstart', speakWithPermission);
                    };
                    
                    document.addEventListener('click', speakWithPermission, { once: true });
                    document.addEventListener('touchstart', speakWithPermission, { once: true });
                    
                    showStatus('ËØ∑ÁÇπÂáªÂ±èÂπïÂºÄÂßãËØ≠Èü≥Êí≠Êä•', 'info');
                } else {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    window.speechSynthesis.speak(utterance);
                }
            } else {
                showStatus('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÂäüËÉΩ', 'warning');
            }
        }
        
        function exportData() {
            if (state.students.length === 0) {
                showStatus('Ê≤°ÊúâÊï∞ÊçÆÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            try {
                const data = state.students.map(student => ({
                    Áè≠Á∫ß: state.currentClass,
                    ÂßìÂêç: student.name,
                    Â≠¶ÂàÜ: student.score,
                    ÁÇπÂêçÁä∂ÊÄÅ: student.called ? 'Â∑≤ÁÇπÂêç' : 'Êú™ÁÇπÂêç',
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Â≠¶ÁîüÊï∞ÊçÆ');
                const colWidths = [
                    {wch: 15},
                    {wch: 10},
                    {wch: 8},
                    {wch: 10},
                ];
                ws['!cols'] = colWidths;
                
                const fileName = `${state.currentClass}_ÁÇπÂêçÊï∞ÊçÆ_${formatExportDate()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showStatus('Êï∞ÊçÆÂØºÂá∫ÊàêÂäü', 'success');
                
            } catch (error) {
                console.error('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                showStatus('ÂØºÂá∫Â§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        function formatExportDate() {
            const now = new Date();
            return `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        function showScoreSummary() {
            const modal = elements.scoreSummaryModal;
            const content = elements.scoreSummaryContent;
            
            if (state.scoreRecords.length === 0) {
                content.innerHTML = '<div class="no-records">ÊöÇÊó†Âä†ÂáèÂàÜËÆ∞ÂΩï</div>';
            } else {
                const studentScores = {};
                state.scoreRecords.forEach(record => {
                    if (!studentScores[record.studentId]) {
                        studentScores[record.studentId] = {
                            name: record.studentName,
                            total: 0,
                            records: []
                        };
                    }
                    studentScores[record.studentId].total += record.points;
                    studentScores[record.studentId].records.push(record);
                });
                
                const sortedStudents = Object.values(studentScores).sort((a, b) => b.total - a.total);
                let html = `
                    <table class="score-summary-table">
                        <thead>
                            <tr>
                                <th>Â≠¶ÁîüÂßìÂêç</th>
                                <th>ÊÄªÂàÜÊï∞</th>
                                <th>Âä†ÂàÜÊ¨°Êï∞</th>
                                <th>ÂáèÂàÜÊ¨°Êï∞</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sortedStudents.forEach(student => {
                    const addCount = student.records.filter(r => r.points > 0).length;
                    const removeCount = student.records.filter(r => r.points < 0).length;
                    
                    html += `
                        <tr>
                            <td>${student.name}</td>
                            <td class="total-points ${student.total < 0 ? 'negative' : ''}">${student.total > 0 ? '+' : ''}${student.total}</td>
                            <td style="color: ${addCount > 0 ? 'var(--success-color)' : '#ccc'}">${addCount}Ê¨°</td>
                            <td style="color: ${removeCount > 0 ? 'var(--danger-color)' : '#ccc'}">${removeCount}Ê¨°</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center; color: #ccc;">
                        ÂÖ± ${state.scoreRecords.length} Êù°Âä†ÂáèÂàÜËÆ∞ÂΩï
                    </div>
                `;
                
                content.innerHTML = html;
            }
            
            modal.classList.add('show');
        }
        
        function closeScoreSummary() {
            elements.scoreSummaryModal.classList.remove('show');
        }
        
        function toggleFullscreen() {
            const docEl = document.documentElement;
            const isFullscreen = !!(document.fullscreenElement || 
                                   document.webkitFullscreenElement || 
                                   document.mozFullScreenElement || 
                                   document.msFullscreenElement);

            if (!isFullscreen) {
                const requestMethods = [
                    docEl.requestFullscreen,
                    docEl.webkitRequestFullscreen,
                    docEl.mozRequestFullScreen,
                    docEl.msRequestFullscreen
                ];

                let success = false;
                for (const method of requestMethods) {
                    if (method) {
                        try {
                            method.call(docEl);
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                }

                if (success) {
                    elements.fullscreenIndicator.classList.add('show');
                    showStatus('Â∑≤ËøõÂÖ•ÂÖ®Â±èÊ®°Âºè', 'info');
                } else {
                    showStatus('ÂÖ®Â±èËØ∑Ê±ÇÂ§±Ë¥•', 'error');
                }
            } else {
                const exitMethods = [
                    document.exitFullscreen,
                    document.webkitExitFullscreen,
                    document.mozCancelFullScreen,
                    document.msExitFullscreen
                ];

                let success = false;
                for (const method of exitMethods) {
                    if (method) {
                        try {
                            method.call(document);
                            success = true;
                            break;
                        } catch (e) {
                            continue;
                        }
                    }
                }

                if (success) {
                    elements.fullscreenIndicator.classList.remove('show');
                    showStatus('Â∑≤ÈÄÄÂá∫ÂÖ®Â±èÊ®°Âºè', 'info');
                } else {
                    showStatus('ÈÄÄÂá∫ÂÖ®Â±èÂ§±Ë¥•', 'error');
                }
            }
        }
        
        function toggleSidebar() {
            elements.sidebar.classList.toggle('hidden');
            if (window.innerWidth <= 768) {
                elements.toggleSidebarBtn.classList.toggle('visible', elements.sidebar.classList.contains('hidden'));
            }
        }
        
        function togglePerformanceMode() {
            state.performanceMode = state.performanceMode === 'high' ? 'low' : 'high';
            elements.performanceMode.textContent = `ÊÄßËÉΩÊ®°Âºè: ${state.performanceMode === 'high' ? 'È´òÂìÅË¥®' : 'È´òÊÄßËÉΩ'}`;
            showStatus(`Â∑≤ÂàáÊç¢Âà∞${state.performanceMode === 'high' ? 'È´òÂìÅË¥®' : 'È´òÊÄßËÉΩ'}Ê®°Âºè`, 'info');
            applyPerformanceSettings();
            updateScenePerformance();
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            elements.fileName.textContent = file.name;
            showStatus(`Ê≠£Âú®Ëß£Êûê ${file.name}...`);
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let className = extractClassName(file.name);
                        if (workbook.SheetNames.length > 0) {
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            if (jsonData.length > 0 && jsonData[0].Áè≠Á∫ß) {
                                className = jsonData[0].Áè≠Á∫ß;
                            }
                            parseStudentData(jsonData, className);
                        }
                    } catch (error) {
                        showStatus("Ëß£ÊûêExcelÊñá‰ª∂Â§±Ë¥•", 'error');
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    try {
                        const results = Papa.parse(e.target.result, { header: true });
                        const className = extractClassName(file.name);
                        parseStudentData(results.data, className);
                    } catch (error) {
                        showStatus("Ëß£ÊûêCSVÊñá‰ª∂Â§±Ë¥•", 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                reader.onload = function(e) {
                    try {
                        mammoth.extractRawText({ arrayBuffer: e.target.result })
                            .then(function(result) {
                                const text = result.value;
                                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                                const jsonData = lines.map((name, index) => ({
                                    ÂßìÂêç: name,
                                    ÁßØÂàÜ: 0,
                                    Âá∫Âã§Ê¨°Êï∞: 0
                                }));
                                const className = extractClassName(file.name);
                                parseStudentData(jsonData, className);
                            })
                            .catch(error => {
                                showStatus("Ëß£ÊûêWordÊñá‰ª∂Â§±Ë¥•", 'error');
                                console.error(error);
                            });
                    } catch (error) {
                        showStatus("Ëß£ÊûêWordÊñá‰ª∂Â§±Ë¥•", 'error');
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.txt')) {
                reader.onload = function(e) {
                    try {
                        const lines = e.target.result.split('\n')
                            .map(line => line.trim())
                            .filter(line => line);
                        
                        const jsonData = lines.map((line, index) => {
                            const parts = line.split(',').map(p => p.trim());
                            return {
                                ÂßìÂêç: parts[0],
                                ÁßØÂàÜ: parts[1] ? parseInt(parts[1]) : 0,
                                Âá∫Âã§Ê¨°Êï∞: 0
                            };
                        });
                        
                        const className = extractClassName(file.name);
                        parseStudentData(jsonData, className);
                    } catch (error) {
                        showStatus("Ëß£ÊûêÊñáÊú¨Êñá‰ª∂Â§±Ë¥•", 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            } else {
                showStatus("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè", 'error');
            }
        }
        
        function extractClassName(filename) {
            const patterns = [
                /(\S+Áè≠)/,
                /(\S+Á∫ß\S+Áè≠)/,
                /(\S+‰∏ì‰∏ö\S+Áè≠)/
            ];
            
            for (const pattern of patterns) {
                const match = filename.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return elements.classSelect.options[elements.classSelect.selectedIndex].text;
        }
        
        function parseStudentData(jsonData, className = null) {
            if (!jsonData || jsonData.length === 0) {
                showStatus("Êú™Ëß£ÊûêÂà∞Â≠¶ÁîüÊï∞ÊçÆ", 'warning');
                return;
            }
            
            const nameFields = ['ÂßìÂêç', 'name', 'Â≠¶ÁîüÂßìÂêç', 'Â≠¶ÂëòÂßìÂêç', 'Â≠¶Áîü', 'Â≠¶Âëò'];
            const scoreFields = ['ÁßØÂàÜ', 'score', 'ÂàÜÊï∞', 'ÊàêÁª©', 'Â≠¶ÂàÜ'];
            const attendanceFields = ['Âá∫Âã§Ê¨°Êï∞', 'attendance', 'Âá∫Âã§', 'Âà∞ËØæÊ¨°Êï∞'];
            
            let nameField = null;
            let scoreField = null;
            let attendanceField = null;
            
            const firstItem = jsonData[0];
            for (const key in firstItem) {
                const keyLower = key.toLowerCase();
                if (!nameField && nameFields.some(f => keyLower.includes(f.toLowerCase()))) {
                    nameField = key;
                }
                if (!scoreField && scoreFields.some(f => keyLower.includes(f.toLowerCase()))) {
                    scoreField = key;
                }
                if (!attendanceField && attendanceFields.some(f => keyLower.includes(f.toLowerCase()))) {
                    attendanceField = key;
                }
            }
            
            if (!nameField) {
                nameField = Object.keys(firstItem)[0];
            }
            
            const newStudents = jsonData.map((item, index) => ({
                id: index + 1,
                name: item[nameField] || `Â≠¶Áîü${index + 1}`,
                score: scoreField ? parseInt(item[scoreField]) || 0 : 0,
                attendance: attendanceField ? parseInt(item[attendanceField]) || 0 : 0,
                called: false
            })).filter(student => student.name.trim() !== '');
            
            if (newStudents.length === 0) {
                showStatus("Êú™Ëß£ÊûêÂà∞ÊúâÊïàÂ≠¶ÁîüÊï∞ÊçÆ", 'warning');
                return;
            }
            
            newStudents.sort((a, b) => b.score - a.score);
            state.classData[state.currentClassKey] = newStudents;
            state.students = [...newStudents];
            
            if (className) {
                let classExists = false;
                for (let i = 0; i < elements.classSelect.options.length; i++) {
                    if (elements.classSelect.options[i].text === className) {
                        elements.classSelect.selectedIndex = i;
                        state.currentClass = elements.classSelect.options[i].text;
                        state.currentClassKey = elements.classSelect.value;
                        elements.currentClass.textContent = className;
                        classExists = true;
                        break;
                    }
                }
                
                if (!classExists) {
                    const newClassValue = `class${elements.classSelect.options.length + 1}`;
                    const newOption = document.createElement('option');
                    newOption.value = newClassValue;
                    newOption.textContent = className;
                    elements.classSelect.appendChild(newOption);
                    elements.classSelect.selectedIndex = elements.classSelect.options.length - 1;
                    state.currentClass = className;
                    state.currentClassKey = newClassValue;
                    elements.currentClass.textContent = className;
                    state.classData[newClassValue] = newStudents;
                }
            }
            
            renderStudentList();
            updateCallStatus();
            
            if (state.sceneLoaded) {
                clearCards();
                createStudentCards();
            }
            
            showStatus(`ÊàêÂäüÂØºÂÖ• ${newStudents.length} ÂêçÂ≠¶Áîü`, 'success');
        }
        
        function initThreeScene() {
            try {
                if (typeof THREE === 'undefined') {
                    throw new Error('Three.jsÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                }
                
                updateLoadingStatus(10, 'Ê≠£Âú®ÂàùÂßãÂåñ...', 'Ê£ÄÊµãÊµèËßàÂô®ÁéØÂ¢É');
                
                state.performanceMode = detectPerformance();
                elements.performanceMode.textContent = `ÊÄßËÉΩÊ®°Âºè: ${state.performanceMode === 'low' ? 'ËäÇËÉΩ' : 'È´òÂìÅË¥®'}`;
                applyPerformanceSettings();
                
                updateLoadingStatus(20, 'Ê≠£Âú®ÂàùÂßãÂåñ...', 'Ê£ÄÊü•WebGLÊîØÊåÅ');
                
                function checkWebGLSupport() {
                    try {
                        const canvas = document.createElement('canvas');
                        return !!(window.WebGLRenderingContext && 
                               (canvas.getContext('webgl') || 
                                canvas.getContext('experimental-webgl')));
                    } catch(e) {
                        return false;
                    }
                }
                
                const webglSupported = checkWebGLSupport();
                if (!webglSupported) {
                    updateLoadingStatus(0, 'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅWebGL', 'Â∞Ü‰ΩøÁî®Âü∫Á°ÄÊ®°ÂºèËøêË°å');
                    console.warn('WebGL is not supported by this browser');
                    
                    setTimeout(() => {
                        elements.loadingIndicator.style.display = 'none';
                        elements.threeContainer.innerHTML = 
                            '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#6a8cff;">' +
                            'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅ3DÊïàÊûúÔºåÂü∫Á°ÄÂäüËÉΩ‰ªçÂèØ‰ΩøÁî®</div>';
                        initSampleStudents();
                    }, 2000);
                    return;
                }
                
                updateLoadingStatus(30, 'Ê≠£Âú®ÂáÜÂ§á3DÁéØÂ¢É...', 'ÂàùÂßãÂåñThree.js');
                
                state.scene = new THREE.Scene();
                state.scene.background = new THREE.Color(0x000000);
                
                const containerWidth = elements.threeContainer.clientWidth;
                const containerHeight = elements.threeContainer.clientHeight;
                
                updateLoadingStatus(40, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ÂàùÂßãÂåñÂú∫ÊôØÂØπË±°');
                
                state.camera = new THREE.PerspectiveCamera(75, containerWidth / containerHeight, 0.1, 1000);
                state.camera.position.z = 40;
                
                updateLoadingStatus(50, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ÂàùÂßãÂåñÊ∏≤ÊüìÂô®');
                
                state.renderer = new THREE.WebGLRenderer({ 
                    canvas: document.getElementById('canvas'),
                    antialias: state.performanceMode !== 'low',
                    alpha: true,
                    powerPreference: state.performanceMode === 'low' ? 'low-power' : 'high-performance'
                });
                state.renderer.setSize(containerWidth, containerHeight);
                state.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                state.renderer.shadowMap.enabled = performanceConfig.enableShadows;
                
                if (state.performanceMode === 'low') {
                    state.renderer.shadowMap.type = THREE.BasicShadowMap;
                } else {
                    state.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                }
                
                elements.threeContainer.appendChild(state.renderer.domElement);
                
                updateLoadingStatus(60, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ËÆæÁΩÆÊéßÂà∂Âô®');
                
                state.controls = new THREE.OrbitControls(state.camera, state.renderer.domElement);
                state.controls.enableDamping = state.performanceMode !== 'low';
                state.controls.dampingFactor = 0.05;
                state.controls.autoRotate = true;
                state.controls.autoRotateSpeed = 0.5;
                
                updateLoadingStatus(70, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ÂàõÂª∫ÁêÉ‰ΩìÂíåÂÖâÊ∫ê');
                
                const sphereGeometry = new THREE.SphereGeometry(24, 32, 32);
                const sphereMaterial = new THREE.MeshBasicMaterial({
                    color: 0x0066ff,
                    wireframe: true,
                    transparent: true,
                    opacity: 0.2
                });
                state.sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                state.scene.add(state.sphere);
                
                const ambientLight = new THREE.AmbientLight(0x222244, 1);
                state.scene.add(ambientLight);
                
                const directionalLight1 = new THREE.DirectionalLight(0x6a8cff, 1);
                directionalLight1.position.set(5, 5, 10);
                directionalLight1.castShadow = performanceConfig.enableShadows;
                
                if (performanceConfig.enableShadows) {
                    directionalLight1.shadow.mapSize.width = state.performanceMode === 'low' ? 512 : 1024;
                    directionalLight1.shadow.mapSize.height = state.performanceMode === 'low' ? 512 : 1024;
                    directionalLight1.shadow.camera.near = 0.5;
                    directionalLight1.shadow.camera.far = 500;
                }
                
                state.scene.add(directionalLight1);
                
                const directionalLight2 = new THREE.DirectionalLight(0xff7eb9, 0.7);
                directionalLight2.position.set(-5, -5, -10);
                state.scene.add(directionalLight2);
                
                updateLoadingStatus(80, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ÁîüÊàêÊòüÁ©∫ËÉåÊôØ');
                
                createStars();
                
                state.cardGroup = new THREE.Group();
                state.scene.add(state.cardGroup);
                
                updateLoadingStatus(90, 'Ê≠£Âú®ÂàõÂª∫3DÂú∫ÊôØ...', 'ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨');
                
                window.addEventListener('resize', onWindowResize);
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                function onMouseClick(event) {
                    if (elements.resultCard.contains(event.target)) {
                        return;
                    }
                    
                    mouse.x = (event.clientX / state.renderer.domElement.clientWidth) * 2 - 1;
                    mouse.y = -(event.clientY / state.renderer.domElement.clientHeight) * 2 + 1;

                    raycaster.setFromCamera(mouse, state.camera);
                    const intersects = raycaster.intersectObjects(state.cardGroup.children);

                    if (intersects.length > 0) {
                        const selectedObject = intersects[0].object;
                        highlightCard(selectedObject);
                    } else {
                        if (state.isRolling) {
                            stopRollCall();
                        } else {
                            startRollCall();
                        }
                    }
                }
                
                elements.resultCard.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                state.renderer.domElement.addEventListener('click', onMouseClick);
                animate();
                state.sceneLoaded = true;
                hideError();
                updateLoadingStatus(100, 'Âä†ËΩΩÂÆåÊàê', 'ÂáÜÂ§áÂ∞±Áª™');
                
            } catch (error) {
                console.error('Three.jsÂàùÂßãÂåñÈîôËØØ:', error);
                state.sceneLoaded = false;
                showError('ÊòüÁ©∫Âú∫ÊôØÂä†ËΩΩÂ§±Ë¥•', error.message);
                if (state.loadAttempts < state.maxLoadAttempts) {
                    state.loadAttempts++;
                    elements.errorDetails.textContent += `ÔºàÂ∞ÜÂú®3ÁßíÂêéÂ∞ùËØïÁ¨¨${state.loadAttempts + 1}Ê¨°Âä†ËΩΩÔºâ`;
                    
                    setTimeout(() => {
                        hideError();
                        initThreeScene();
                    }, 3000);
                }
            }
        }
        
        function createStars() {
            state.stars.forEach(star => {
                state.scene.remove(star);
            });
            state.stars = [];
            
            const starGeometry = new THREE.BufferGeometry();
            const starCount = performanceConfig.starCount;
            const positions = new Float32Array(starCount * 3);
            const colors = new Float32Array(starCount * 3);
            const sizes = new Float32Array(starCount);
            
            for (let i = 0; i < starCount; i++) {
                const i3 = i * 3;
                positions[i3] = (Math.random() - 0.5) * 2000;
                positions[i3 + 1] = (Math.random() - 0.5) * 2000;
                positions[i3 + 2] = (Math.random() - 0.5) * 2000;
                
                colors[i3] = Math.random() * 0.5 + 0.5;
                colors[i3 + 1] = Math.random() * 0.5 + 0.5;
                colors[i3 + 2] = Math.random() * 0.5 + 0.5;
                
                sizes[i] = Math.random() * 3 + 1;
            }
            
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            starGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            
            const starMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    pointTexture: { 
                        value: (function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = 64;
                            canvas.height = 64;
                            const context = canvas.getContext('2d');
                            
                            const gradient = context.createRadialGradient(32, 32, 0, 32, 32, 32);
                            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
                            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.8)');
                            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                            
                            context.fillStyle = gradient;
                            context.fillRect(0, 0, 64, 64);
                            
                            const texture = new THREE.Texture(canvas);
                            texture.needsUpdate = true;
                            return texture;
                        })()
                    }
                },
                vertexShader: `
                    attribute float size;
                    attribute vec3 color;
                    varying vec3 vColor;
                    void main() {
                        vColor = color;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_PointSize = size * (300.0 / -mvPosition.z);
                        gl_Position = projectionMatrix * mvPosition;
                    }
                `,
                fragmentShader: `
                    uniform sampler2D pointTexture;
                    varying vec3 vColor;
                    void main() {
                        gl_FragColor = vec4(vColor, 1.0) * texture2D(pointTexture, gl_PointCoord);
                        if (gl_FragColor.a < 0.1) discard;
                    }
                `,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true
            });
            
            const starField = new THREE.Points(starGeometry, starMaterial);
            state.scene.add(starField);
            state.stars.push(starField);
        }
        
        function createStudentCards() {
            clearCards();
            if (state.students.length === 0) return;
            
            const cardMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    color1: { value: new THREE.Color(0x1a1c35) },
                    color2: { value: new THREE.Color(0x2d305e) },
                    selected: { value: 0 }
                },
                vertexShader: `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform vec3 color1;
                    uniform vec3 color2;
                    uniform float selected;
                    varying vec2 vUv;
                    void main() {
                        vec3 color = mix(color1, color2, vUv.y);
                        if (selected > 0.5) {
                            color = mix(color, vec3(0.415, 0.55, 1.0), 0.3);
                        }
                        gl_FragColor = vec4(color, 0.9);
                }
                `,
                side: THREE.DoubleSide,
                transparent: true
            });
            
            state.students.forEach((student, index) => {
                const sphereRadius = 21.5;
                const goldenRatio = (1 + Math.sqrt(5)) / 2;
                const y = 1 - (index / (state.students.length - 1)) * 2;
                const radius = Math.sqrt(1 - y * y);
                const theta = 2 * Math.PI * index / goldenRatio;
                
                const x = Math.cos(theta) * radius * sphereRadius;
                const z = Math.sin(theta) * radius * sphereRadius;
                const finalY = y * sphereRadius;
                
                const targetX = x;
                const targetY = finalY;
                const targetZ = z;
                
                const cardGeometry = new THREE.PlaneGeometry(
                    state.performanceMode === 'low' ? 8 : 10 * 0.67, 
                    state.performanceMode === 'low' ? 5 : 7 * 0.67
                );
                
                const baseScale = 0.8 + Math.random() * 0.4;
                const card = new THREE.Mesh(cardGeometry, cardMaterial);
                card.position.set(targetX, targetY, targetZ);
                card.lookAt(state.camera.position);
                card.scale.set(baseScale, baseScale, baseScale);
                card.castShadow = performanceConfig.enableShadows;
                card.receiveShadow = performanceConfig.enableShadows;
                
                card.userData = {
                    studentId: student.id,
                    targetPosition: new THREE.Vector3(targetX, targetY, targetZ),
                    spherePosition: new THREE.Vector3(targetX, targetY, targetZ),
                    isSelected: false,
                    ÂÖ•Âú∫Âä®ÁîªËøõÂ∫¶: 0,
                    baseScale: baseScale,
                    floatOffset: Math.random() * Math.PI * 2,
                    floatSpeed: 0.005 + Math.random() * 0.005,
                    rotationSpeed: (Math.random() - 0.5) * 0.01
                };
                
                createNameTexture(card, student.name, student.score);
                state.cardGroup.add(card);
                state.cards.push(card);
            });
            
            state.isAnimatingCards = true;
            state.cardAnimationProgress = 0;
        }
        
        function createNameTexture(card, name, score) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = state.performanceMode === 'low' ? 256 : 512;
            canvas.height = state.performanceMode === 'low' ? 128 : 256;
            
            const gradient = context.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'rgba(26, 28, 53, 0.5)');
            gradient.addColorStop(1, 'rgba(45, 48, 94, 0.5)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            const nameFontSize = state.performanceMode === 'low' ? 18 : 36;
            context.font = `bold ${nameFontSize}px Arial, sans-serif`;
            
            const textGradient = context.createLinearGradient(0, 0, canvas.width, 0);
            textGradient.addColorStop(0, '#6a8cff');
            textGradient.addColorStop(1, '#ff7eb9');
            context.fillStyle = textGradient;
            
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(name, canvas.width / 2, canvas.height / 2 - (state.performanceMode === 'low' ? 10 : 20));
            
            const scoreFontSize = state.performanceMode === 'low' ? 12 : 24;
            context.font = `bold ${scoreFontSize}px Arial, sans-serif`;
            
            let scoreGradient;
            if (score < 0) {
                // Ë¥üÂàÜÊòæÁ§∫Á∫¢Ëâ≤
                scoreGradient = context.createLinearGradient(0, 0, canvas.width, 0);
                scoreGradient.addColorStop(0, '#ff6b6b');
                scoreGradient.addColorStop(1, '#ff922b');
            } else if (score === 0) {
                // Èõ∂ÂàÜÊòæÁ§∫ÁÅ∞Ëâ≤
                scoreGradient = context.createLinearGradient(0, 0, canvas.width, 0);
                scoreGradient.addColorStop(0, '#cccccc');
                scoreGradient.addColorStop(1, '#999999');
            } else {
                // Ê≠£ÂàÜÊòæÁ§∫ÁªøËâ≤
                scoreGradient = context.createLinearGradient(0, 0, canvas.width, 0);
                scoreGradient.addColorStop(0, '#51cf66');
                scoreGradient.addColorStop(1, '#7fffcb');
            }
            context.fillStyle = scoreGradient;
            
            context.fillText(`ÁßØÂàÜ: ${score}`, canvas.width / 2, canvas.height / 2 + (state.performanceMode === 'low' ? 30 : 60));
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.DoubleSide,
                transparent: true
            });
            
            const textPlane = new THREE.PlaneGeometry(
                state.performanceMode === 'low' ? 7 : 9,
                state.performanceMode === 'low' ? 4 : 5
            );
            const textMesh = new THREE.Mesh(textPlane, material);
            textMesh.position.z = 0.01;
            card.add(textMesh);
        }
        
        function clearCards() {
            if (state.scene && state.cardGroup) {
                state.cards.forEach(card => {
                    state.cardGroup.remove(card);
                });
            }
            state.cards = [];
        }
        
        function updateCardScore(studentId, score) {
            const card = state.cards.find(c => c.userData.studentId === studentId);
            if (card) {
                for (let i = card.children.length - 1; i >= 0; i--) {
                    const child = card.children[i];
                    if (child instanceof THREE.Mesh && child.material && child.material.map) {
                        card.remove(child);
                    }
                }
                
                const student = state.students.find(s => s.id === studentId);
                if (student) {
                    createNameTexture(card, student.name, score);
                }
            }
        }
        
        function highlightCard(card) {
            if (state.selectedCard) {
                if (state.selectedCard.material && state.selectedCard.material.uniforms) {
                    state.selectedCard.material.uniforms.selected.value = state.selectedCard.userData.isSelected ? 1 : 0;
                }
                state.selectedCard.scale.set(
                    state.selectedCard.userData.baseScale, 
                    state.selectedCard.userData.baseScale, 
                    state.selectedCard.userData.baseScale
                );
                state.selectedCard = null;
            }
            
            state.selectedCard = card;
            if (state.selectedCard.material && state.selectedCard.material.uniforms) {
                state.selectedCard.material.uniforms.selected.value = 1;
            }
            state.selectedCard.scale.set(
                state.selectedCard.userData.baseScale * 0.65, 
                state.selectedCard.userData.baseScale * 0.65, 
                state.selectedCard.userData.baseScale * 0.65
            );
            state.selectedCard.userData.originalPosition = card.position.clone();
            
            const student = state.students.find(s => s.id === card.userData.studentId);
            if (student) {
                showStatus(`ÈÄâ‰∏≠: ${student.name} (ÁßØÂàÜ: ${student.score})`, 'info');
            }
        }
        
        function onWindowResize() {
            const containerWidth = elements.threeContainer.clientWidth;
            const containerHeight = elements.threeContainer.clientHeight;
            
            if (state.camera) {
                state.camera.aspect = containerWidth / containerHeight;
                state.camera.updateProjectionMatrix();
            }
            
            if (state.renderer) {
                state.renderer.setSize(containerWidth, containerHeight);
            }
        }
        
        function animate() {
            state.animationId = requestAnimationFrame(animate);
            
            if (state.controls) state.controls.update();

            if (state.isRolling) {
                state.cardGroup.rotation.y += state.currentRotationSpeed.y;
                state.cardGroup.rotation.x += state.currentRotationSpeed.x * 0.5;
                state.sphere.rotation.y += state.currentRotationSpeed.y;
                state.sphere.rotation.x += state.currentRotationSpeed.x * 0.5;
            }

            if (state.isAnimatingCards && state.cardAnimationProgress < 1) {
                state.cardAnimationProgress += state.performanceMode === 'low' ? 0.01 : 0.02;
                const easeProgress = easeOutCubic(state.cardAnimationProgress);
                
                state.cards.forEach(card => {
                    card.userData.ÂÖ•Âú∫Âä®ÁîªËøõÂ∫¶ = easeProgress;
                    const startPos = new THREE.Vector3(
                        card.position.x, 
                        card.position.y, 
                        card.position.z
                    );
                    const targetPos = card.userData.targetPosition;
                    card.position.lerpVectors(startPos, targetPos, easeProgress);
                    card.lookAt(state.camera.position);
                    
                    const scale = THREE.MathUtils.lerp(0.05, 0.5, easeProgress) * card.userData.baseScale;
                    card.scale.set(scale, scale, scale);
                });
                
                if (state.cardAnimationProgress >= 1) {
                    state.isAnimatingCards = false;
                }
            } else if (!state.isAnimatingCards && !state.isRolling) {
                const time = Date.now() * 0.001;
                state.cards.forEach(card => {
                    const floatX = Math.sin(time * card.userData.floatSpeed + card.userData.floatOffset) * 0.5;
                    const floatY = Math.cos(time * card.userData.floatSpeed * 1.3 + card.userData.floatOffset) * 0.5;
                    const floatZ = Math.sin(time * card.userData.floatSpeed * 0.7 + card.userData.floatOffset) * 0.3;
                    
                    card.position.x = card.userData.targetPosition.x + floatX;
                    card.position.y = card.userData.targetPosition.y + floatY;
                    card.position.z = card.userData.targetPosition.z + floatZ;
                    
                    card.rotation.z += card.userData.rotationSpeed;
                    card.lookAt(state.camera.position);
                    card.rotation.z += Math.sin(time * 0.002 + card.userData.floatOffset) * 0.1;
                });
            }
            
            if (state.isAnimatingSphere) {
                state.sphereAnimationProgress += state.performanceMode === 'low' ? 0.02 : 0.04;
                const easeProgress = easeOutCubic(state.sphereAnimationProgress);
                
                state.cards.forEach(card => {
                    if (state.isRolling) {
                        card.position.lerpVectors(
                            card.userData.targetPosition, 
                            card.userData.spherePosition, 
                            easeProgress
                        );
                    } else {
                        card.position.lerpVectors(
                            card.userData.spherePosition, 
                            card.userData.targetPosition, 
                            easeProgress
                        );
                    }
                    
                    const lookAtPos = state.isRolling ? new THREE.Vector3(0, 0, 0) : state.camera.position;
                    card.lookAt(lookAtPos);
                    
                    card.scale.set(
                        card.userData.baseScale, 
                        card.userData.baseScale, 
                        card.userData.baseScale
                    );
                });
                
                if (state.sphereAnimationProgress >= 1) {
                    state.isAnimatingSphere = false;
                    state.sphereAnimationProgress = 0;
                }
            }
            
            if (state.isRolling) {
                state.cardGroup.rotation.y += state.currentRotationSpeed.y;
                state.cardGroup.rotation.x += state.currentRotationSpeed.x;
            }
            
            if (state.selectedCard) {
                const bounce = Math.sin(Date.now() * 0.005) * 0.05;
                state.selectedCard.position.y = state.selectedCard.userData.originalPosition.y + bounce;
            }
            
            if (state.scene && state.camera) {
                state.renderer.render(state.scene, state.camera);
            }
        }
        
        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }
        
        function setupEventListeners() {
            elements.startRollBtn.addEventListener('click', startRollCall);
            elements.stopRollBtn.addEventListener('click', stopRollCall);
            elements.closeResult.addEventListener('click', () => {
                elements.resultCard.classList.remove('show');
            });
            
            elements.voiceToggle.addEventListener('click', () => {
                state.voiceEnabled = !state.voiceEnabled;
                elements.voiceToggle.classList.toggle('active', state.voiceEnabled);
                showStatus(state.voiceEnabled ? 'ËØ≠Èü≥Êí≠Êä•Â∑≤ÂºÄÂêØ' : 'ËØ≠Èü≥Êí≠Êä•Â∑≤ÂÖ≥Èó≠', 'info');
            });
            
            elements.dropdownToggle.addEventListener('click', () => {
                elements.multiSelectDropdown.classList.toggle('show');
            });
            
            document.addEventListener('click', (e) => {
                if (!elements.dropdownToggle.contains(e.target) && 
                    !elements.multiSelectDropdown.contains(e.target)) {
                    elements.multiSelectDropdown.classList.remove('show');
                }
            });
            
            elements.multiSelectDropdown.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const number = parseInt(e.target.dataset.number);
                    state.selectedNumber = number;
                    elements.selectedNumberDisplay.textContent = `${number}‰∫∫`;
                    
                    elements.multiSelectDropdown.querySelectorAll('a').forEach(i => i.classList.remove('selected'));
                    e.target.classList.add('selected');
                    
                    elements.multiSelectDropdown.classList.remove('show');
                    showStatus(`Â∑≤ËÆæÁΩÆÊØèÊ¨°ÁÇπÂêçÈÄâÊã©${number}‰∫∫`, 'info');
                });
            });
            
            elements.gestureToggle.addEventListener('click', toggleGesture);
            
            // Èü≥‰πêÊéßÂà∂Áõ∏ÂÖ≥‰∫ã‰ª∂
            elements.musicControlBtn.addEventListener('click', toggleMusicPanel);
            elements.musicCloseBtn.addEventListener('click', toggleMusicPanel);
            elements.uploadMusic.addEventListener('change', handleMusicUpload);
            elements.playMusic.addEventListener('click', playMusic);
            elements.pauseMusic.addEventListener('click', pauseMusic);
            
            // ÁÇπÂáªÈü≥‰πêÈù¢ÊùøÂ§ñÈÉ®ÂÖ≥Èó≠
            document.addEventListener('click', (e) => {
                if (state.musicPanelVisible && 
                    !elements.musicPanel.contains(e.target) && 
                    !elements.musicControlBtn.contains(e.target)) {
                    toggleMusicPanel();
                }
            });
            
            elements.viewScoreSummaryBtn.addEventListener('click', showScoreSummary);
            elements.closeScoreSummary.addEventListener('click', closeScoreSummary);
            elements.scoreSummaryModal.addEventListener('click', (e) => {
                if (e.target === elements.scoreSummaryModal) {
                    closeScoreSummary();
                }
            });
            
            elements.uploadFile.addEventListener('change', handleFileUpload);
            elements.classSelect.addEventListener('change', () => {
                state.currentClass = elements.classSelect.options[elements.classSelect.selectedIndex].text;
                state.currentClassKey = elements.classSelect.value;
                elements.currentClass.textContent = state.currentClass;
                showStatus(`Â∑≤ÂàáÊç¢Âà∞${state.currentClass}`, 'info');
                
                state.students = [...state.classData[state.currentClassKey]];
                state.students.sort((a, b) => b.score - a.score);
                renderStudentList();
                updateCallStatus();
                
                clearCards();
                createStudentCards();
            });
            
            // Âä†ÂàÜÊåâÈíÆ
            elements.addScoreBtn.addEventListener('click', () => {
                addScoreToSelected(1);
            });
            
            // ÂáèÂàÜÊåâÈíÆ (Êñ∞Â¢û)
            elements.removeScoreBtn.addEventListener('click', () => {
                removeScoreFromSelected(1);
            });
            
            elements.resetScoreBtn.addEventListener('click', resetScores);
            elements.resetCallBtn.addEventListener('click', resetCallRecords);
            elements.exportBtn.addEventListener('click', exportData);
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            elements.toggleSidebarBtn.addEventListener('click', toggleSidebar);
            elements.performanceMode.addEventListener('click', togglePerformanceMode);
            
            elements.editSave.addEventListener('click', saveStudentEdit);
            elements.editCancel.addEventListener('click', cancelStudentEdit);
            
            elements.resultList.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (e.target.classList.contains('add-point-btn')) {
                    const studentId = parseInt(e.target.dataset.id);
                    addScore(studentId, 1);
                } else if (e.target.classList.contains('remove-point-btn')) {
                    const studentId = parseInt(e.target.dataset.id);
                    addScore(studentId, -1);
                } else if (e.target.classList.contains('remove-btn')) {
                    const studentId = parseInt(e.target.dataset.id);
                    removeStudentFromResults(studentId);
                }
            });
            
            elements.groupAddPointBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addScoreToAllSelectedInResult(1);
            });
            
            // ‰∏∫ÊâÄÊúâÈÄâ‰∏≠Â≠¶ÁîüÂáèÂàÜÊåâÈíÆ (Êñ∞Â¢û)
            elements.groupRemovePointBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeScoreFromAllSelectedInResult(1);
            });
            
            elements.studentList.addEventListener('dblclick', (e) => {
                const studentItem = e.target.closest('.student-item');
                if (studentItem) {
                    const checkbox = studentItem.querySelector('.checkbox');
                    const studentId = parseInt(checkbox.dataset.id);
                    openEditStudentModal(studentId);
                }
            });
            
            elements.errorRetry.addEventListener('click', () => {
                hideError();
                elements.loadingIndicator.style.display = 'block';
                elements.loadingIndicator.style.opacity = '1';
                elements.loadingBar.style.width = '0%';
                initThreeScene();
            });
            
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    elements.sidebar.classList.remove('hidden');
                    elements.toggleSidebarBtn.classList.remove('visible');
                } else {
                    elements.toggleSidebarBtn.classList.toggle('visible', elements.sidebar.classList.contains('hidden'));
                }
                
                if (state.renderer) {
                    onWindowResize();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (state.isRolling) {
                        stopRollCall();
                    } else {
                        startRollCall();
                    }
                } else if (e.code === 'Equal' && e.shiftKey) { // + ÈîÆ
                    e.preventDefault();
                    addScoreToSelected(1);
                } else if (e.code === 'Minus') { // - ÈîÆ
                    e.preventDefault();
                    removeScoreFromSelected(1);
                }
            });
        }
        
        function openEditStudentModal(studentId) {
            const student = state.students.find(s => s.id === studentId);
            if (student) {
                elements.editStudentId.value = student.id;
                elements.editStudentName.value = student.name;
                elements.editStudentScore.value = student.score;
                elements.editModal.classList.add('show');
            }
        }

        function saveStudentEdit() {
            const studentId = parseInt(elements.editStudentId.value);
            const student = state.students.find(s => s.id === studentId);
            
            if (student) {
                student.name = elements.editStudentName.value.trim();
                student.score = parseFloat(elements.editStudentScore.value) || 0;
                
                renderStudentList();
                renderResults();
                updateCard(studentId, student.name, student.score);
                showStatus('Â≠¶Áîü‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞', 'success');
            }
            
            elements.editModal.classList.remove('show');
        }

        function cancelStudentEdit() {
            elements.editModal.classList.remove('show');
        }
        
        function showError(message, details = '') {
            elements.errorDetails.textContent = details || message;
            elements.errorMessage.classList.add('show');
            console.error('Error:', message, details);
        }

        function hideError() {
            elements.errorMessage.classList.remove('show');
        }
        
        function initApp() {
            setupEventListeners();
            initThreeScene();
            initGestureRecognition();
            initSampleStudents();
            elements.multiSelectDropdown.querySelector(`a[data-number="${state.selectedNumber}"]`).classList.add('selected');
            
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.add('hidden');
                elements.toggleSidebarBtn.classList.add('visible');
            }
        }
        
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
